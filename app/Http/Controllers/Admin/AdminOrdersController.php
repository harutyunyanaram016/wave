<?phpnamespace App\Http\Controllers\Admin;use App\Order;use App\Referal;use App\ReferalSetting;use App\User;use Illuminate\Http\Request;use App\Http\Controllers\Controller;class AdminOrdersController extends Controller{    public function index()    {        $orders = Order::all();        return view('admin.orders.index', ['orders' => $orders]);    }    public function payed(Request $request){        $request->validate([            'id' => 'required|numeric',        ]);        $order = Order::findOrFail($request->get('id'));        $settings = ReferalSetting::find(1);        if($order){            Referal::create([                'user_id'=>$order->user_id,                'referal_type'=>'order',                'order_id'=>$order->id,                'order_sum'=>$order->totalAmount,                'prcent'=>$settings->order_prsent,            ]);            $userOr = User::findOrFail($order->user_id);            if($userOr->parent_id){            }            $userOr->bonus = $userOr->bonus + $order->totalAmount*$settings->order_prsent/100;            $userOr->save();            if($userOr->parent_id){                Referal::create([                    'user_id'=>$userOr->parent_id,                    'referal_type'=>'referal',                    'order_id'=>$order->id,                    'order_sum'=>$order->totalAmount,                    'prcent'=>$settings->partner_prsent,                    'children_id'=>$userOr->id,                ]);                $parent = User::findOrFail($userOr->parent_id);                $parent->bonus = $parent->bonus + $order->totalAmount*$settings->partner_prsent/100;                $parent->save();            }            $order->status = "PAYED";            $order->save();            return response()->json(['message' => 'yes']);        }        return response()->json(['message' => 'no']);    }    public function panding(Request $request){        $request->validate([            'id' => 'required|numeric',        ]);        $order = Order::findOrFail($request->get('id'));        if($order){            $referals = Referal::where('order_id',$order->id)->get();            if(!empty($referals) && count($referals)>0){                foreach ($referals as $referal){                    $userOr = User::findOrFail($referal->user_id);                    $userOr->bonus = $userOr->bonus - $order->totalAmount*$referal->prcent/100;                    $userOr->save();                    Referal::findOrFail($referal->id)->delete();                }            }            $order->status = "PENDING";            $order->save();            return response()->json(['message' => 'yes']);        }        return response()->json(['message' => 'no']);    }}